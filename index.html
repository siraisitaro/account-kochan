<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™ä¼šçµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ (Microeconomics Ed.)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; font-size: 0.875rem; font-weight: bold; color: #374151; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; }
        .danger-zone { background-color: #fee2e2; color: #b91c1c; font-weight: bold; }
        .safe-zone { background-color: #d1fae5; color: #047857; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">â›ª æ•™ä¼šçµŒå–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
            <p class="text-gray-600">Microeconomics Analysis Tool for Small Communities</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-4">
                
                <div class="card">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ“Š åŸºç¤ã‚³ã‚¹ãƒˆè¨­å®š</h2>
                    <div class="input-group">
                        <label class="input-label">å›ºå®šè²» (Cf) / æœˆ</label>
                        <input type="number" id="fixedCost" class="input-field" value="320000">
                    </div>
                    <div class="input-group">
                        <label class="input-label">å˜ä½å¯å¤‰è²» (v) / äºº</label>
                        <input type="number" id="variableCost" class="input-field" value="83">
                    </div>
                    <div class="input-group">
                        <label class="input-label">ç¾åœ¨ã®é é‡‘æ®‹é«˜ (ä½™å‘½è¨ˆç®—ç”¨)</label>
                        <input type="number" id="savings" class="input-field" value="380000">
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">ğŸ’° çŒ®é‡‘æ§‹æˆ (ä¾¡æ ¼å·®åˆ¥)</h2>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500">å±¤A (æ”¯ãˆã‚‹æŸ±)</label>
                            <input type="number" id="priceA" class="input-field text-sm" value="20000">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ§‹æˆæ¯” (%)</label>
                            <input type="number" id="ratioA" class="input-field text-sm" value="30">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500">å±¤B (é€šå¸¸)</label>
                            <input type="number" id="priceB" class="input-field text-sm" value="5000">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ§‹æˆæ¯” (%)</label>
                            <input type="number" id="ratioB" class="input-field text-sm" value="50">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs font-bold text-gray-500">å±¤C (å­¦ç”Ÿç­‰)</label>
                            <input type="number" id="priceC" class="input-field text-sm" value="500">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ§‹æˆæ¯” (%)</label>
                            <input type="number" id="ratioC" class="input-field text-sm" value="20">
                        </div>
                    </div>
                    
                    <div class="mt-4 p-2 bg-blue-50 rounded text-center">
                        <span class="text-sm text-blue-800">åŠ é‡å¹³å‡å˜ä¾¡(P): </span>
                        <strong id="weightedPDisplay" class="text-lg text-blue-900">Â¥8,600</strong>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 space-y-6">
                
                <div class="card">
                    <canvas id="cvpChart"></canvas>
                </div>

                <div class="card overflow-x-auto">
                    <h2 class="text-xl font-bold mb-4">ğŸ“ˆ æç›Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</h2>
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3">äººæ•° (Q)</th>
                                <th class="px-4 py-3">ä¸€äººå½“ã‚³ã‚¹ãƒˆ(AC)</th>
                                <th class="px-4 py-3">æœˆé–“æç›Š</th>
                                <th class="px-4 py-3">ä½™å‘½ (ãƒ¶æœˆ)</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer class="mt-12 text-center text-gray-400 text-sm">
            <p>Built with Creative Partnership logic. Open Source ready.</p>
        </footer>
    </div>

    <script>
        // --- è¨­å®šå€¤ ---
        const maxPeople = 50;
        let chartInstance = null;

        // --- DOMè¦ç´ ã®å–å¾— ---
        const inputs = document.querySelectorAll('input');
        
        // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
        function calculate() {
            // å…¥åŠ›å€¤ã®å–å¾—
            const Cf = parseFloat(document.getElementById('fixedCost').value) || 0;
            const v = parseFloat(document.getElementById('variableCost').value) || 0;
            const savings = parseFloat(document.getElementById('savings').value) || 0;

            const pA = parseFloat(document.getElementById('priceA').value) || 0;
            const rA = parseFloat(document.getElementById('ratioA').value) / 100 || 0;
            const pB = parseFloat(document.getElementById('priceB').value) || 0;
            const rB = parseFloat(document.getElementById('ratioB').value) / 100 || 0;
            const pC = parseFloat(document.getElementById('priceC').value) || 0;
            const rC = parseFloat(document.getElementById('ratioC').value) / 100 || 0;

            // åŠ é‡å¹³å‡å˜ä¾¡ã®è¨ˆç®—
            const weightedP = (pA * rA) + (pB * rB) + (pC * rC);
            document.getElementById('weightedPDisplay').innerText = `Â¥${Math.round(weightedP).toLocaleString()}`;

            // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const labels = [];
            const dataAC = [];
            const dataP = [];
            const tableData = [];

            for (let q = 1; q <= maxPeople; q++) {
                const ac = (Cf / q) + v;
                const monthlyProfit = (weightedP - ac) * q;
                
                let burnRate = "---";
                if (monthlyProfit < 0) {
                    const months = savings / Math.abs(monthlyProfit);
                    burnRate = months < 100 ? months.toFixed(1) + "ãƒ¶æœˆ" : "99+ãƒ¶æœˆ";
                } else {
                    burnRate = "é»’å­—ç¶­æŒ";
                }

                labels.push(q);
                dataAC.push(ac);
                dataP.push(weightedP);

                tableData.push({
                    q: q,
                    ac: ac,
                    profit: monthlyProfit,
                    burnRate: burnRate
                });
            }

            return { labels, dataAC, dataP, tableData, weightedP };
        }

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function render() {
            const { labels, dataAC, dataP, tableData, weightedP } = calculate();

            // 1. ãƒãƒ£ãƒ¼ãƒˆæç”»
            const ctx = document.getElementById('cvpChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å¹³å‡è²»ç”¨ (AC) - ç”Ÿå­˜ãƒ©ã‚¤ãƒ³',
                            data: dataAC,
                            borderColor: 'rgb(239, 68, 68)', // Red
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 1
                        },
                        {
                            label: 'å¹³å‡çŒ®é‡‘ (P) - åå…¥ãƒ©ã‚¤ãƒ³',
                            data: dataP,
                            borderColor: 'rgb(59, 130, 246)', // Blue
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æç›Šåˆ†å²ç‚¹åˆ†æ (Break-even Analysis)'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ": Â¥" + Math.round(context.raw).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40000, // ã‚°ãƒ©ãƒ•ã®è¦‹ã‚„ã™ã•ã®ãŸã‚ã«ä¸Šé™è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
                            title: { display: true, text: 'é‡‘é¡ (å††)' }
                        },
                        x: {
                            title: { display: true, text: 'ä¼šå“¡æ•° (äºº)' }
                        }
                    }
                }
            });

            // 2. ãƒ†ãƒ¼ãƒ–ãƒ«æç”» (ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºä»˜ã)
            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = '';

            // é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼ˆ10äººã€œ40äººï¼‰ã‚’è¡¨ç¤ºã€ã¾ãŸã¯å…¨ä»¶è¡¨ç¤º
            tableData.forEach(row => {
                // ç°¡æ˜“åŒ–ã®ãŸã‚5äººåˆ»ã¿ + 12äºº(ç¾çŠ¶)ä»˜è¿‘ã‚’è¡¨ç¤º
                if (row.q % 5 === 0 || row.q === 12 || row.q === 13) {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-gray-50";
                    
                    // èµ¤å­—ãƒ»é»’å­—ã®åˆ¤å®šã‚¯ãƒ©ã‚¹
                    const profitClass = row.profit >= 0 ? "text-green-600 font-bold" : "text-red-600 font-bold";
                    const bgClass = row.profit >= 0 ? "bg-green-50" : "bg-red-50";
                    
                    // ãƒãƒ¼ãƒ³ãƒ¬ãƒ¼ãƒˆã®è­¦å‘Šè‰²
                    let burnClass = "";
                    if (row.profit < 0 && parseFloat(row.burnRate) < 3) burnClass = "text-red-700 font-black animate-pulse";

                    tr.innerHTML = `
                        <td class="px-4 py-3 font-medium text-gray-900 ${bgClass}">${row.q}äºº</td>
                        <td class="px-4 py-3">Â¥${Math.round(row.ac).toLocaleString()}</td>
                        <td class="px-4 py-3 ${profitClass}">Â¥${Math.round(row.profit).toLocaleString()}</td>
                        <td class="px-4 py-3 ${burnClass}">${row.burnRate}</td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        inputs.forEach(input => {
            input.addEventListener('input', render);
        });

        // åˆæœŸæç”»
        render();

    </script>
</body>
</html>