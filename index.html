<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KyokaiTsuku Mobile DX - v3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f1f5f9; height: 100dvh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
        .chart-container { position: relative; height: 160px; width: 100%; }
        
        /* アニメーション定義 */
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .btn-pop:active { animation: pop 0.1s; }
        
        .modal-bg { background-color: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="text-slate-800 flex flex-col select-none">

    <nav class="bg-slate-900 text-white shrink-0 shadow-lg px-4 py-3 z-20">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <span class="bg-yellow-500 text-slate-900 text-xs font-black px-1.5 rounded">DX</span>
                <span class="font-bold text-sm tracking-wide">教会経営シミュレーション</span>
            </div>
            <div class="text-xs font-mono text-slate-400 bg-slate-800 px-2 py-1 rounded border border-slate-700">
                Y<span id="uiYear">1</span> / M<span id="uiMonth">1</span> / W<span id="uiWeek">1</span>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-2">
            <div class="bg-slate-800 rounded p-1.5 text-center border border-slate-700">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider">Funds</div>
                <div class="font-bold text-emerald-400 text-sm truncate">¥<span id="uiFunds">0</span></div>
            </div>
            <div class="bg-slate-800 rounded p-1.5 text-center border border-slate-700">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider">Believers</div>
                <div class="font-bold text-blue-300 text-sm"><span id="uiMembers">0</span><span class="text-[10px] text-slate-500">/<span id="uiCap">0</span></span></div>
            </div>
            <div class="bg-slate-800 rounded p-1.5 text-center border border-slate-700">
                <div class="text-[10px] text-slate-400 uppercase tracking-wider">Cost/W</div>
                <div class="font-bold text-red-400 text-sm">¥<span id="uiCost">0</span></div>
            </div>
        </div>
    </nav>

    <main id="mainArea" class="flex-grow bg-slate-100 p-4 pb-32 overflow-y-auto scroll-smooth"></main>

    <div class="fixed bottom-24 right-5 z-30 flex flex-col items-end gap-2">
        <div id="tutorialTip" class="bg-white px-3 py-1.5 rounded-lg shadow-md text-xs font-bold text-slate-600 border border-slate-200 animate-bounce hidden">
            ← 週を進める
        </div>
        <button onclick="app.processWeek()" class="w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center border-[3px] border-white btn-pop shadow-slate-400/50">
            <i class="fa-solid fa-play text-xl text-yellow-500 ml-1"></i>
        </button>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-2 pb-safe-area-bottom safe-area-bottom z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button onclick="app.setTab('dashboard')" class="nav-btn w-16 py-1 flex flex-col items-center gap-1 text-slate-400 transition-colors" data-target="dashboard">
            <i class="fa-solid fa-chart-pie text-lg"></i>
            <span class="text-[10px] font-bold">経営</span>
        </button>
        <button onclick="app.setTab('personnel')" class="nav-btn w-16 py-1 flex flex-col items-center gap-1 text-slate-400 transition-colors" data-target="personnel">
            <i class="fa-solid fa-users text-lg"></i>
            <span class="text-[10px] font-bold">人事</span>
        </button>
        <button onclick="app.setTab('facility')" class="nav-btn w-16 py-1 flex flex-col items-center gap-1 text-slate-400 transition-colors" data-target="facility">
            <i class="fa-solid fa-building text-lg"></i>
            <span class="text-[10px] font-bold">施設</span>
        </button>
    </nav>

    <div id="resultModal" class="fixed inset-0 modal-bg z-[60] hidden items-center justify-center p-6">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-slide-up">
            <div class="bg-slate-900 p-4 text-center">
                <h3 class="text-white font-bold text-sm tracking-widest">WEEKLY REPORT</h3>
            </div>
            <div class="p-6">
                <div class="flex justify-between items-end mb-4 border-b pb-4">
                    <div class="text-slate-500 text-xs font-bold">収支結果</div>
                    <div class="text-xl font-black" id="resNet">±0</div>
                </div>
                <div class="space-y-2 text-sm mb-6">
                    <div class="flex justify-between">
                        <span class="text-slate-500"><i class="fa-solid fa-sack-dollar w-5"></i> 献金収入</span>
                        <span class="font-bold text-emerald-600" id="resIncome">+0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500"><i class="fa-solid fa-file-invoice-dollar w-5"></i> 運営経費</span>
                        <span class="font-bold text-red-500" id="resExpense">-0</span>
                    </div>
                    <div class="flex justify-between mt-2 pt-2 border-t border-dashed">
                        <span class="text-slate-500"><i class="fa-solid fa-users w-5"></i> 来会者</span>
                        <span class="font-bold text-slate-800" id="resAtt">0名</span>
                    </div>
                    <div id="resWarning" class="hidden mt-2 p-2 bg-red-50 text-red-600 text-xs font-bold rounded text-center">
                        <i class="fa-solid fa-triangle-exclamation"></i> ケア不足で信徒が離れました！
                    </div>
                </div>
                <button onclick="app.closeResult()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition active:scale-95">
                    次の週へ進む
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-16 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl transition-opacity opacity-0 pointer-events-none z-50 transform scale-90"></div>

    <script>
        // --- データ定義 ---
        const FACILITIES = [
            { name: '自宅開放', cost: 0, upkeep: 5000, cap: 15, bonus: 0, desc: 'まずはここから。家賃はタダ。' },
            { name: '貸し会議室', cost: 300000, upkeep: 30000, cap: 40, bonus: 10, desc: '少し広くなりました。' },
            { name: '雑居ビル', cost: 1500000, upkeep: 80000, cap: 80, bonus: 20, desc: 'それっぽくなってきました。' },
            { name: '専用会堂', cost: 10000000, upkeep: 250000, cap: 200, bonus: 50, desc: '夢のマイホーム（教会）。' },
            { name: '大聖堂', cost: 100000000, upkeep: 1000000, cap: 1000, bonus: 150, desc: '地域のランドマーク。' }
        ];

        const ROLES = {
            pastor: { label: '牧師', icon: 'fa-user-tie', color: 'text-indigo-500', bg: 'bg-indigo-50' },
            staff: { label: 'スタッフ', icon: 'fa-user', color: 'text-emerald-500', bg: 'bg-emerald-50' },
            admin: { label: '事務員', icon: 'fa-calculator', color: 'text-orange-500', bg: 'bg-orange-50' }
        };

        // --- ゲームエンジン ---
        const game = {
            state: {
                year: 1, month: 1, week: 1,
                funds: 1000000, // 初期資金100万
                members: 5,
                facilityLevel: 0,
                staff: [],
                candidates: [], // 雇用候補者
                history: []
            },
            
            // データ保存・読込
            save() { localStorage.setItem('kt_dx_v3', JSON.stringify(this.state)); },
            load() { 
                const d = localStorage.getItem('kt_dx_v3'); 
                if(d) this.state = JSON.parse(d);
                // 候補者がいなければ生成
                if(!this.state.candidates || this.state.candidates.length === 0) this.refreshCandidates();
            },
            reset() { localStorage.removeItem('kt_dx_v3'); location.reload(); },

            // 計算ロジック
            calcStats() {
                let p = 10, c = 10, a = 10; // 基礎値
                let salaries = 0;
                this.state.staff.forEach(s => { 
                    p += s.stats.preach; 
                    c += s.stats.care; 
                    a += s.stats.admin; 
                    salaries += s.salary;
                });
                const f = FACILITIES[this.state.facilityLevel];
                // 説教ボーナス加算
                p += f.bonus;
                
                // 週次維持費 = 施設維持費 + 人件費(月給)の1/4
                const weeklyCost = Math.floor(f.upkeep + (salaries / 4));
                return { preach: p, care: c, admin: a, weeklyCost };
            },

            // 週の処理
            processWeek() {
                const s = this.state;
                const stats = this.calcStats();
                const f = FACILITIES[s.facilityLevel];

                // 1. 来会者計算 (メンバー数 * 参加率)
                // 説教力が高いと参加率が上がる (基本80% + 説教力%)
                let rate = 0.8 + (stats.preach * 0.005);
                let attendance = Math.floor(s.members * Math.min(rate, 1.2)); // 最大120%
                attendance = Math.min(attendance, f.cap); // 施設上限でカット

                // 2. 収入計算 (人数 * 単価)
                // 事務力が高いと献金単価が上がる (基本2000円 + 事務力*20円)
                let unitPrice = 2000 + (stats.admin * 20);
                let income = attendance * unitPrice;

                // 3. メンバー増減
                // 新規 = 説教力 / 20
                let newMembers = Math.floor(stats.preach / 20);
                // 離脱 = ケア不足分 (メンバー数*3 が必要ケア値)
                let reqCare = s.members * 3;
                let lostMembers = 0;
                if (stats.care < reqCare) {
                    lostMembers = Math.ceil((reqCare - stats.care) / 10);
                }

                s.members = Math.max(1, s.members + newMembers - lostMembers);
                s.funds += (income - stats.weeklyCost);

                // 時間経過
                s.week++;
                if(s.week > 4) { s.week = 1; s.month++; if(s.month>12){ s.month=1; s.year++; } }
                
                // 履歴記録（直近12週）
                s.history.push({ w: `${s.month}/${s.week}`, m: s.members });
                if(s.history.length > 12) s.history.shift();

                this.save();
                return { income, expense: stats.weeklyCost, attendance, newMembers, lostMembers };
            },

            // スタッフ生成
            refreshCandidates() {
                const names = ['佐藤', '鈴木', '田中', '高橋', '渡辺', '伊藤', '山本', '中村'];
                const types = ['pastor', 'staff', 'admin'];
                this.state.candidates = Array.from({length: 3}, () => {
                    const type = types[Math.floor(Math.random() * types.length)];
                    const rank = Math.floor(Math.random() * 5) + 1; // 1-5
                    const base = rank * 10;
                    return {
                        id: Date.now() + Math.random(),
                        name: names[Math.floor(Math.random() * names.length)],
                        role: type,
                        rank: rank,
                        // 能力値の偏りを作る
                        stats: {
                            preach: type==='pastor' ? base*2 : base,
                            care: type==='staff' ? base*2 : base,
                            admin: type==='admin' ? base*2 : base
                        },
                        salary: rank * 30000, // 月給
                        contractFee: rank * 50000 // 契約金
                    };
                });
            }
        };

        // --- UI制御 ---
        const app = {
            currentTab: 'dashboard',
            chart: null,

            init() {
                game.load();
                // 初期スタッフがいなければ作成
                if (game.state.staff.length === 0) {
                    game.state.staff.push({ 
                        id: 0, name: 'あなた', role: 'pastor', rank: 1, 
                        stats: { preach: 20, care: 20, admin: 20 }, salary: 150000 
                    });
                }
                this.updateUI();
                this.render();
                
                // 初回のみチュートリアル表示
                if(game.state.year === 1 && game.state.month === 1 && game.state.week === 1) {
                    document.getElementById('tutorialTip').classList.remove('hidden');
                }
            },

            setTab(tab) {
                this.currentTab = tab;
                // タブボタンのアクティブ化
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if(btn.dataset.target === tab) {
                        btn.classList.remove('text-slate-400');
                        btn.classList.add('text-slate-900');
                    } else {
                        btn.classList.add('text-slate-400');
                        btn.classList.remove('text-slate-900');
                    }
                });
                this.render();
            },

            updateUI() {
                const s = game.state;
                const stats = game.calcStats();
                const f = FACILITIES[s.facilityLevel];
                
                document.getElementById('uiYear').innerText = s.year;
                document.getElementById('uiMonth').innerText = s.month;
                document.getElementById('uiWeek').innerText = s.week;
                document.getElementById('uiFunds').innerText = s.funds.toLocaleString();
                document.getElementById('uiMembers').innerText = s.members;
                document.getElementById('uiCap').innerText = f.cap;
                document.getElementById('uiCost').innerText = stats.weeklyCost.toLocaleString();
            },

            processWeek() {
                // 資金チェック
                if(game.state.funds < 0) {
                    if(!confirm("資金がマイナスです！ゲームオーバーになりますが、リセットしてやり直しますか？")) return;
                    game.reset(); return;
                }

                document.getElementById('tutorialTip').classList.add('hidden');
                const res = game.processWeek();
                
                // 結果表示
                const net = res.income - res.expense;
                const netEl = document.getElementById('resNet');
                netEl.innerText = (net >= 0 ? '+' : '') + `¥${net.toLocaleString()}`;
                netEl.className = `text-xl font-black ${net >= 0 ? 'text-emerald-600' : 'text-red-600'}`;
                
                document.getElementById('resIncome').innerText = `+¥${res.income.toLocaleString()}`;
                document.getElementById('resExpense').innerText = `-¥${res.expense.toLocaleString()}`;
                document.getElementById('resAtt').innerText = `${res.attendance}名`;
                
                const warnEl = document.getElementById('resWarning');
                if(res.lostMembers > 0) {
                    warnEl.classList.remove('hidden');
                    warnEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ケア不足により${res.lostMembers}名が離脱しました`;
                } else {
                    warnEl.classList.add('hidden');
                }

                document.getElementById('resultModal').classList.remove('hidden');
                document.getElementById('resultModal').classList.add('flex');
                
                this.updateUI();
            },

            closeResult() {
                document.getElementById('resultModal').classList.add('hidden');
                document.getElementById('resultModal').classList.remove('flex');
                this.render(); // グラフ更新のため
            },

            // 各タブの描画
            render() {
                const main = document.getElementById('mainArea');
                const s = game.state;
                const stats = game.calcStats();
                const f = FACILITIES[s.facilityLevel];

                if (this.currentTab === 'dashboard') {
                    // ダッシュボード
                    main.innerHTML = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 animate-slide-up">
                            <h2 class="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wider">Church Stats</h2>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-black text-slate-800">${stats.preach}</div>
                                    <div class="text-[10px] text-slate-500 font-bold">説教力</div>
                                    <div class="text-[9px] text-slate-400">新規獲得</div>
                                </div>
                                <div>
                                    <div class="text-lg font-black ${stats.care < s.members*3 ? 'text-red-500' : 'text-slate-800'}">${stats.care}</div>
                                    <div class="text-[10px] text-slate-500 font-bold">ケア力</div>
                                    <div class="text-[9px] text-slate-400">必要: ${s.members*3}</div>
                                </div>
                                <div>
                                    <div class="text-lg font-black text-slate-800">${stats.admin}</div>
                                    <div class="text-[10px] text-slate-500 font-bold">事務力</div>
                                    <div class="text-[9px] text-slate-400">収益UP</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4 animate-slide-up" style="animation-delay: 0.05s">
                            <h2 class="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">Growth Chart</h2>
                            <div class="chart-container">
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="if(confirm('データ初期化しますか？')) game.reset()" class="text-xs text-red-300 underline">データリセット</button>
                        </div>
                    `;
                    this.renderChart();

                } else if (this.currentTab === 'personnel') {
                    // 人事タブ
                    main.innerHTML = `
                        <div class="space-y-4 pb-20 animate-slide-up">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div class="bg-slate-50 px-4 py-2 text-xs font-bold text-slate-500 border-b">現在のスタッフ (${s.staff.length}名)</div>
                                ${s.staff.map(st => `
                                    <div class="p-3 border-b last:border-0 flex justify-between items-center">
                                        <div class="flex items-cent
