<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KyokaiTsuku Mobile DX - Ver.2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        church: { 800: '#1e293b', 900: '#0f172a' },
                        gold: { 500: '#eab308' },
                        rank: { S: '#eab308', A: '#f43f5e', B: '#3b82f6', C: '#22c55e', D: '#94a3b8' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; user-select: none; font-family: sans-serif; height: 100dvh; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .worship-active { animation: pulse-gold 1.5s infinite; border-color: #eab308; background-color: #eab308; }
        .chart-container { position: relative; height: 180px; width: 100%; }
        /* トーストアニメーション */
        @keyframes slide-in { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-msg { animation: slide-in 0.3s ease-out; }
    </style>
</head>
<body class="text-slate-800 flex flex-col overflow-hidden">

    <nav class="bg-church-900 text-white shrink-0 shadow-lg z-20 relative pt-[env(safe-area-inset-top,0px)]">
        <div class="px-4 py-2">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center space-x-2">
                    <div class="bg-gold-500 text-church-900 px-1.5 py-0.5 rounded font-black italic text-sm">KT2</div>
                    <span class="font-bold text-sm">教会経営DX</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="app.resetGame()" class="text-xs text-red-400 hover:text-red-300 border border-red-900 px-2 py-1 rounded">Reset</button>
                    <div class="text-xs font-mono text-slate-400 border-l border-slate-600 pl-3">
                        Y<span id="uiYear">1</span>-M<span id="uiMonth">1</span>-W<span id="uiWeek">1</span>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-2 text-[10px] text-center">
                <div class="bg-church-800 rounded p-1">
                    <div class="text-slate-400 scale-90">資金 (Funds)</div>
                    <div class="font-bold text-emerald-400 text-xs" id="uiFunds">¥0</div>
                </div>
                <div class="bg-church-800 rounded p-1">
                    <div class="text-slate-400 scale-90">信徒数 (Members)</div>
                    <div class="font-bold text-blue-300 text-xs"><span id="uiMembers">0</span> / <span id="uiCap" class="text-slate-500">20</span></div>
                </div>
                <div class="bg-church-800 rounded p-1">
                    <div class="text-slate-400 scale-90">月間維持費</div>
                    <div class="font-bold text-red-400 text-xs" id="uiCost">¥0</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex flex-grow overflow-hidden relative">
        <main class="flex-grow bg-slate-100 p-4 pb-32 overflow-y-auto" id="mainArea"></main>

        <div class="fixed bottom-24 right-5 z-30 flex flex-col items-end gap-2">
            <div id="tutorialMsg" class="bg-white p-2 rounded shadow text-xs text-slate-600 hidden">← 礼拝を開催して週を進める</div>
            <button onclick="app.processWeek()" id="actionBtn" class="w-16 h-16 bg-church-900 text-white rounded-full shadow-2xl flex items-center justify-center border-4 border-white active:scale-95 transition-transform">
                <i class="fa-solid fa-person-praying text-2xl text-gold-500"></i>
            </button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-start pt-3 px-2 z-40 safe-area-bottom shadow-[0_-4px_10px_rgba(0,0,0,0.05)] h-20">
        <button onclick="app.setTab('dashboard')" class="flex flex-col items-center gap-1 w-16 nav-icon text-church-900" data-target="dashboard">
            <i class="fa-solid fa-chart-line text-lg"></i><span class="text-[10px] font-bold">経営</span>
        </button>
        <button onclick="app.setTab('personnel')" class="flex flex-col items-center gap-1 w-16 nav-icon text-slate-400" data-target="personnel">
            <i class="fa-solid fa-user-tie text-lg"></i><span class="text-[10px] font-bold">人事</span>
        </button>
        <button onclick="app.setTab('facility')" class="flex flex-col items-center gap-1 w-16 nav-icon text-slate-400" data-target="facility">
            <i class="fa-solid fa-church text-lg"></i><span class="text-[10px] font-bold">設備</span>
        </button>
    </nav>

    <div id="resultModal" class="fixed inset-0 bg-church-900/90 z-[60] hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-[slide-in_0.2s]">
            <div class="bg-church-900 text-white p-3 text-center font-bold">週次報告 (Weekly Report)</div>
            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="p-2 bg-emerald-50 rounded border border-emerald-100">
                        <div class="text-[10px] text-slate-500">収入 (Offering)</div>
                        <div class="text-lg font-bold text-emerald-600" id="resIncome">+¥0</div>
                    </div>
                    <div class="p-2 bg-red-50 rounded border border-red-100">
                        <div class="text-[10px] text-slate-500">支出 (Expenses)</div>
                        <div class="text-lg font-bold text-red-600" id="resExpense">-¥0</div>
                    </div>
                </div>
                
                <div class="space-y-1 text-sm border-t border-b border-slate-100 py-3">
                    <div class="flex justify-between">
                        <span>来会者数</span>
                        <span class="font-bold" id="resAtt">0名</span>
                    </div>
                    <div class="flex justify-between text-blue-600">
                        <span>新規定着</span>
                        <span class="font-bold" id="resNew">+0</span>
                    </div>
                    <div class="flex justify-between text-red-500">
                        <span>離脱者 (Care不足)</span>
                        <span class="font-bold" id="resLost">-0</span>
                    </div>
                </div>

                <div class="text-center">
                    <div class="text-xs text-slate-400 mb-1">現在の資金</div>
                    <div class="text-2xl font-black text-church-900" id="resTotal">¥0</div>
                </div>

                <button onclick="app.closeResult()" class="w-full bg-gold-500 hover:bg-gold-400 text-church-900 py-3 rounded-xl font-bold shadow-lg">次の週へ</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-16 left-1/2 transform -translate-x-1/2 w-11/12 max-w-sm z-50 pointer-events-none space-y-2"></div>

    <script>
        /* --- CONFIG & DATA --- */
        const SAVE_KEY = 'kt_dx_v2';
        const ROLES = { 
            pastor: { label: '牧師', icon: 'fa-user-tie' }, 
            worship: { label: '奏楽', icon: 'fa-music' }, 
            admin: { label: '事務', icon: 'fa-calculator' } 
        };
        // 設備データ: cost=購入費, upkeep=週維持費, cap=収容人数, bonus=説教ボーナス
        const FACILITIES = [
            { id: 0, name: '自宅開放', cost: 0, upkeep: 5000, cap: 15, bonus: 0 },
            { id: 1, name: '貸し会議室', cost: 300000, upkeep: 20000, cap: 40, bonus: 10 },
            { id: 2, name: 'テナント小', cost: 1500000, upkeep: 50000, cap: 80, bonus: 20 },
            { id: 3, name: 'テナント大', cost: 5000000, upkeep: 120000, cap: 150, bonus: 40 },
            { id: 4, name: '専用会堂', cost: 20000000, upkeep: 300000, cap: 400, bonus: 80 }
        ];

        /* --- GAME LOGIC --- */
        const game = {
            state: {
                year: 1, month: 1, week: 1,
                funds: 1000000, // 初期資金減らしました
                members: 5,
                facilityLevel: 0,
                staff: [],
                history: [] // グラフ用履歴
            },
            
            // 重要な計算ロジック
            calcStats() {
                let preach = 0, care = 0, admin = 0;
                // スタッフ能力の合計
                this.state.staff.forEach(s => {
                    preach += s.stats.preach;
                    care += s.stats.care;
                    admin += s.stats.admin;
                });
                // 設備ボーナス
                preach += FACILITIES[this.state.facilityLevel].bonus;
                
                // 固定費計算 (人件費 + 設備維持費)
                const salaryTotal = this.state.staff.reduce((a, b) => a + b.salary, 0);
                const facilityUpkeep = FACILITIES[this.state.facilityLevel].upkeep;
                const weeklyCost = Math.floor((salaryTotal / 4) + facilityUpkeep); // 月給を週割

                return { preach, care, admin, weeklyCost };
            },

            processWeek() {
                const s = this.state;
                const stats = this.calcStats();
                const facility = FACILITIES[s.facilityLevel];

                // 1. 来会者計算 (基本メンバー + 説教力による変動 + ランダム)
                // 説教力が低いとメンバーさえ来なくなるリスク
                let attendanceRate = 0.7 + (stats.preach * 0.005); 
                if(attendanceRate > 1.2) attendanceRate = 1.2; // 上限
                let attendance = Math.floor(s.members * attendanceRate);
                
                // キャパシティ制限
                if(attendance > facility.cap) attendance = facility.cap;

                // 2. 収入計算 (1人あたり平均2000円 + 事務能力ボーナス)
                const perPerson = 2000 + (stats.admin * 10); 
                const income = attendance * perPerson;

                // 3. 新規と離脱 (チャーン)
                // 新規: 説教力依存
                let newMembers = Math.floor(stats.preach / 20) + (Math.random() > 0.5 ? 1 : 0);
                if(stats.preach < 10) newMembers = 0; // 説教力が低すぎると新規ゼロ
                
                // 離脱: ケア力不足で発生 (メンバー10人につきケア力20必要とする)
                const requiredCare = s.members * 2; 
                let lostMembers = 0;
                if (stats.care < requiredCare && s.members > 5) {
                    const deficit = requiredCare - stats.care;
                    lostMembers = Math.ceil(deficit / 50); // 不足分に応じて離脱
                }

                // 結果反映
                let currentMembers = s.members + newMembers - lostMembers;
                if(currentMembers < 0) currentMembers = 0;
                // キャパを超えた定着は難しい (キャパの110%まで)
                if(currentMembers > facility.cap * 1.1) {
                    currentMembers = Math.floor(facility.cap * 1.1);
                    app.toast("施設が狭すぎて入りきれません！", "red");
                }
                
                s.members = currentMembers;
                s.funds = s.funds + income - stats.weeklyCost;

                // 時間経過
                s.week++;
                if(s.week > 4) { s.week = 1; s.month++; if(s.month>12){s.month=1; s.year++;} }

                // 履歴保存 (グラフ用、直近10週)
                s.history.push({ w: `${s.month}/${s.week}`, m: s.members });
                if(s.history.length > 12) s.history.shift();

                this.save();
                return { income, expense: stats.weeklyCost, attendance, newMembers, lostMembers };
            },

            generateStaff() {
                const names = ['ヨシュア', 'カレブ', 'デボラ', 'ギデオン', 'サムソン', 'アンナ'];
                const roleKeys = Object.keys(ROLES);
                const role = roleKeys[Math.floor(Math.random() * roleKeys.length)];
                // ランク: 0(D) ~ 4(S)
                const rankIdx = Math.floor(Math.random() * Math.random() * 5); 
                const rankChar = ['D','C','B','A','S'][rankIdx];
                const base = (rankIdx + 1) * 15;
                
                // ロールごとの得意不得意
                let st = { preach: base, care: base, admin: base };
                if(role === 'pastor') st.preach *= 1.5;
                if(role === 'worship') st.care *= 1.5;
                if(role === 'admin') st.admin *= 1.5;

                // 給料: 能力に比例 + 契約金
                const salary = (rankIdx + 1) * 60000; // 月給
                const cost = salary * 2; // 契約金

                return { 
                    id: Date.now() + Math.random(), 
                    name: names[Math.floor(Math.random()*names.length)], 
                    role, rank: rankChar, 
                    stats: { preach: Math.floor(st.preach), care: Math.floor(st.care), admin: Math.floor(st.admin) }, 
                    salary, cost 
                };
            },

            save() { localStorage.setItem(SAVE_KEY, JSON.stringify(this.state)); },
            load() { 
                const d = localStorage.getItem(SAVE_KEY); 
                if(d) { this.state = JSON.parse(d); return true; } 
                return false; 
            },
            reset() { localStorage.removeItem(SAVE_KEY); location.reload(); }
        };

        /* --- UI CONTROLLER --- */
        let membersChart = null;

        const app = {
            currentTab: 'dashboard',
            candidates: [],

            init() {
                if (!game.load()) { 
                    // 初期スタッフ
                    game.state.staff = [{ id: 1, name: 'あなた', role: 'pastor', rank: 'C', stats: { preach: 30, care: 20, admin: 20 }, salary: 150000, cost: 0 }];
                }
                this.candidates = Array.from({length: 3}, () => game.generateStaff());
                this.updateUI();
                this.render();
            },

            processWeek() {
                const res = game.processWeek();
                
                // モーダル表示
                document.getElementById('resIncome').innerText = `+¥${res.income.toLocaleString()}`;
                document.getElementById('resExpense').innerText = `-¥${res.expense.toLocaleString()}`;
                document.getElementById('resAtt').innerText = `${res.attendance}名`;
                document.getElementById('resNew').innerText = `+${res.newMembers}`;
                document.getElementById('resLost').innerText = res.lostMembers > 0 ? `-${res.lostMembers}` : '0';
                document.getElementById('resTotal').innerText = `¥${game.state.funds.toLocaleString()}`;
                
                // 破産判定
                if(game.state.funds < 0) {
                    alert('資金が底をつきました...教会は閉鎖されます。\n(データはリセットされます)');
                    game.reset();
                    return;
                }

                document.getElementById('resultModal').classList.replace('hidden', 'flex');
                this.updateUI();
            },

            closeResult() { 
                document.getElementById('resultModal').classList.replace('flex', 'hidden'); 
                this.render(); // グラフ更新などのため再描画
            },

            updateUI() {
                const s = game.state;
                const stats = game.calcStats();
                const facility = FACILITIES[s.facilityLevel];

                document.getElementById('uiYear').innerText = s.year;
                document.getElementById('uiMonth').innerText = s.month;
                document.getElementById('uiWeek').innerText = s.week;
                document.getElementById('uiFunds').innerText = `¥${s.funds.toLocaleString()}`;
                document.getElementById('uiMembers').innerText = s.members;
                document.getElementById('uiCap').innerText = facility.cap;
                document.getElementById('uiCost').innerText = `¥${(stats.weeklyCost * 4).toLocaleString()}`; // 月換算で表示

                // タブの状態更新
                document.querySelectorAll('.nav-icon').forEach(el => {
                    if (el.getAttribute('data-target') === this.currentTab) {
                        el.classList.replace('text-slate-400', 'text-church-900');
                    } else {
                        el.classList.replace('text-church-900', 'text-slate-400');
                    }
                });
            },

            setTab(tab) {
                this.currentTab = tab;
                this.render();
            },

            render() {
                const main = document.getElementById('mainArea');
                const s = game.state;
                const stats = game.calcStats();

                if (this.currentTab === 'dashboard') {
                    // 必要なケア力の計算
                    const reqCare = s.members * 2;
                    const careColor = stats.care >= reqCare ? 'text-emerald-500' : 'text-red-500';

                    main.innerHTML = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                            <h2 class="font-bold text-church-900 text-sm mb-3 border-b pb-2">現在の能力値</h2>
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <div class="text-[10px] text-slate-400">説教力 (集客)</div>
                                    <div class="font-black text-lg text-church-800">${stats.preach}</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400">ケア力 (維持)</div>
                                    <div class="font-black text-lg ${careColor}">${stats.care}</div>
                                    <div class="text-[9px] text-slate-400">必要: ${reqCare}</div>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-400">事務力 (単価)</div>
                                    <div class="font-black text-lg text-church-800">${stats.admin}</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                            <h2 class="font-bold text-church-900 text-sm mb-2">信徒数推移</h2>
                            <div class="chart-container">
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 pb-20">
                            <h2 class="font-bold text-church-900 text-sm mb-3">雇用中のスタッフ</h2>
                            <div class="space-y-2">
                                ${s.staff.map(st => `
                                    <div class="text-xs p-2 bg-slate-50 border border-slate-100 rounded flex justify-between items-center">
                                        <div>
                                            <span class="font-bold text-church-900">${st.name}</span>
                                            <span class="text-slate-500 ml-1 text-[10px]">${ROLES[st.role].label}</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-mono">¥${st.salary.toLocaleString()}/月</div>
         
