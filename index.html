<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gospel Quest: Noah's Logic</title>
    <style>
        /* ã‚¹ãƒãƒ›ã®ãƒãƒ¼ã‚’è€ƒæ…®ã—ãŸé«˜ã•è¨­å®š */
        :root {
            --gh: 100dvh; 
        }

        body { 
            background-color: #1a1a2e; 
            color: #e0e0e0; 
            font-family: 'Courier New', monospace; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: var(--gh); 
            overflow: hidden; 
            touch-action: none;
        }

        #game-container { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            height: 100%; 
            background: #16213e; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box;
        }
        
        /* 1. ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ‘ãƒ¼ãƒˆ */
        #story-screen { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 15px; 
            box-sizing: border-box;
            gap: 10px;
        }
        
        #scene-image { 
            width: 100%; 
            height: 40%; /* ç”»é¢ã®4å‰²ã‚’ç”»åƒã« */
            background: #000; 
            border: 2px solid #533483; 
            overflow: hidden; 
            position: relative;
            flex-shrink: 0;
        }
        
        #scene-image img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ç”»åƒå…¨ä½“ãŒè¦‹ãˆã‚‹ã‚ˆã†ã« */
            display: block;
        }

        #text-box { 
            flex: 1; 
            border: 2px solid #e94560; 
            border-radius: 5px; 
            padding: 12px; 
            background: rgba(0,0,0,0.6); 
            font-size: 14px; 
            line-height: 1.5; 
            overflow-y: auto; 
            color: #fff; 
        }

        .name-tag { color: #e94560; font-weight: bold; margin-bottom: 3px; display: block; }
        
        #action-btn { 
            width: 100%;
            padding: 12px; 
            background: #0f3460; 
            color: #00d4ff; 
            border: 1px solid #00d4ff; 
            font-weight: bold; 
            font-size: 16px; 
            cursor: pointer;
            flex-shrink: 0;
        }

        /* 2. ãƒãƒˆãƒ«ãƒ‘ãƒ¼ãƒˆ */
        #battle-screen { display: none; width: 100%; height: 100%; position: relative; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        #battle-ui { position: absolute; top: 10px; left: 10px; color: white; pointer-events: none; text-shadow: 1px 1px 0 #000; z-index: 5; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="story-screen">
        <div id="scene-image"></div>
        <div id="text-box">
            <span class="name-tag">ã‚·ã‚¹ãƒ†ãƒ </span>
            Loading...
        </div>
        <button id="action-btn" onclick="nextScript()">â–¼ NEXT</button>
    </div>

    <div id="battle-screen">
        <div id="battle-ui">Noah's Logic: <span id="target-name">Enemy</span></div>
        <canvas id="gameCanvas"></canvas>
    </div>
</div>

<script>
    // --- ğŸ‘“ ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ï¼ˆimages/ ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‚ç…§ï¼‰ ---
    const scenario = [
        { 
            id: 0, type: "story", 
            speaker: "ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³",
            text: "åŒ—æ±åŒ—ã®å¯’å†·éƒ½å¸‚ã€æ£®å²¡ã‚·ãƒ†ã‚£ã€‚\nå²©æ‰‹å±±ã®å†·ãŸã„é¢¨ãŒå¹ãè’ã‚Œã‚‹è¡—ã®ç‰‡éš…ã«ã€ãã®æ•™ä¼šã¯ã‚ã£ãŸã€‚", 
            img: "images/bg_city.png" 
        },
        { 
            id: 1, type: "story", 
            speaker: "ãƒã‚¢ç‰§å¸«",
            text: "ã€Œã“ã“ãŒâ€¦â€¦ã¿ãªã¿ãƒãƒ£ãƒ¼ãƒã€‚ä¸»ã®å°ãã«æ„Ÿè¬ã‚’ã€‚ã—ã‹ã—ã€ãšã„ã¶ã‚“å¯‚ã‚Œã¦ã„ã¾ã™ã­ã€", 
            img: "images/noah_stand.png" 
        },
        { 
            id: 2, type: "story", 
            speaker: "æ•™ä¼šå½¹å“¡",
            text: "ã€Œãƒã‚¢å…ˆç”Ÿï¼ æœ€è¿‘ã€æ€ªã—ã„ç‹¼ã®æ ¼å¥½ã‚’ã—ãŸè€…ãŒä¿¡å¾’ã‚’æƒ‘ã‚ã›ã¦ã„ã‚‹ã®ã§ã™ï¼ã€", 
            img: "images/npc_officer.png" 
        },
        { 
            id: 3, type: "story", 
            speaker: "ãƒã‚¢ç‰§å¸«",
            text: "ã€Œâ€¦â€¦ç¾Šã®çš®ã‚’è¢«ã£ãŸç‹¼ã€ã§ã™ã‹ã€‚è«–ç†çš„ã«ãŠã‹ã—ã„æ•™ç†ã¯ç§ãŒè«–ç ´ã—ã¾ã™ã€", 
            img: "images/noah_logic.png" 
        },
        { 
            id: 4, type: "battle", 
            speaker: "ã‚·ã‚¹ãƒ†ãƒ ",
            text: "ï¼ï¼è«–æˆ¦é–‹å§‹ï¼ï¼\nã€ç•°ç«¯ã®ç‹¼ã€‘ã‚’è«–ç ´ã›ã‚ˆï¼", 
            enemyName: "ç•°ç«¯ã®ç‹¼", difficulty: 1,
            img: "images/enemy_wolf.png"
        },
        { 
            id: 5, type: "story", 
            speaker: "ãƒã‚¢ç‰§å¸«",
            text: "ã€Œã‚ãªãŸã®è§£é‡ˆã«ã¯æ–‡è„ˆãŒæ¬ å¦‚ã—ã¦ã„ã¾ã™ã€‚æ‚”ã„æ”¹ã‚ãªã•ã„ã€", 
            img: "images/noah_logic.png" 
        },
        { 
            id: 6, type: "story", 
            speaker: "ç•°ç«¯ã®ç‹¼",
            text: "ã€Œã†ã‚ã‚ããï¼ ãã†ã®éŸ³ã‚‚å‡ºãªã„æ­£è«–ã ããï¼ã€", 
            img: "images/enemy_wolf.png" 
        }
    ];

    let currentStep = 0;
    const textBox = document.getElementById("text-box");
    const sceneImg = document.getElementById("scene-image");
    const storyScreen = document.getElementById("story-screen");
    const battleScreen = document.getElementById("battle-screen");
    const targetNameSpan = document.getElementById("target-name");

    function showImage(filename) {
        if (!filename) {
            sceneImg.innerHTML = `<div style="color:#555; padding:20px;">No Image</div>`;
        } else {
            sceneImg.innerHTML = `<img src="${filename}" alt="scene" onerror="this.src='https://via.placeholder.com/400x300?text=Image+Not+Found'">`;
        }
    }

    function nextScript() {
        if (currentStep >= scenario.length) {
            textBox.innerHTML = "ç¬¬1ç«  å®Œ";
            return;
        }
        const data = scenario[currentStep];
        if (data.type === "story") {
            textBox.innerHTML = `<span class="name-tag">${data.speaker}</span>${data.text.replace(/\n/g, '<br>')}`;
            showImage(data.img);
            currentStep++;
        } else if (data.type === "battle") {
            textBox.innerHTML = `<span class="name-tag">${data.speaker}</span>${data.text}`;
            showImage(data.img);
            const btn = document.getElementById("action-btn");
            btn.innerText = "âš”ï¸ LOGICAL BREAK";
            btn.onclick = () => {
                startBattle(data.difficulty, data.enemyName);
                btn.onclick = nextScript; 
            };
        }
    }

    // --- ğŸ§± ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ  ---
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let gameLoopId, ball, paddle, bricks, score, requiredScore;

    function startBattle(difficulty, enemyName) {
        storyScreen.classList.add("hidden");
        battleScreen.style.display = "block";
        targetNameSpan.innerText = enemyName;
        canvas.width = battleScreen.clientWidth;
        canvas.height = battleScreen.clientHeight;
        initGameObjects(difficulty);
        gameLoop();
    }

    function initGameObjects(difficulty) {
        paddle = { x: canvas.width/2 - 50, y: canvas.height - 60, w: 100, h: 12 };
        ball = { x: canvas.width/2, y: canvas.height - 100, dx: 4, dy: -4 - difficulty, r: 8 };
        bricks = [];
        const rows = 4 + difficulty;
        const cols = 5;
        const padding = 10;
        const bW = (canvas.width - (padding * (cols + 1))) / cols;
        for(let c=0; c<cols; c++) {
            bricks[c] = [];
            for(let r=0; r<rows; r++) {
                bricks[c][r] = { x: c*(bW+padding)+padding, y: r*(20+padding)+60, w: bW, h: 20, status: 1 };
            }
        }
        requiredScore = rows * cols;
        score = 0;
    }

    function gameLoop() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        bricks.forEach(col => col.forEach(b => {
            if(b.status === 1) {
                ctx.fillStyle = "#e94560"; 
                ctx.fillRect(b.x, b.y, b.w, b.h);
            }
        }));
        ctx.fillStyle = "#00d4ff";
        ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
        ctx.closePath();

        // è¡çªåˆ¤å®š
        bricks.forEach(col => col.forEach(b => {
            if(b.status === 1 && ball.x > b.x && ball.x < b.x+b.w && ball.y > b.y && ball.y < b.y+b.h) {
                ball.dy = -ball.dy; b.status = 0; score++;
            }
        }));

        if(ball.x + ball.dx > canvas.width - ball.r || ball.x + ball.dx < ball.r) ball.dx = -ball.dx;
        if(ball.y + ball.dy < ball.r) ball.dy = -ball.dy;
        if(ball.y + ball.dy > paddle.y - ball.r && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
            ball.dy = -Math.abs(ball.dy);
            ball.dx = ((ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2)) * 6;
        } else if (ball.y > canvas.height) {
            ball.y = paddle.y - 20; ball.dy = -4; // è½ä¸‹æ•‘æ¸ˆ
        }

        ball.x += ball.dx; ball.y += ball.dy;

        canvas.ontouchmove = (e) => {
            e.preventDefault();
            let rect = canvas.getBoundingClientRect();
            let rx = e.touches[0].clientX - rect.left;
            paddle.x = rx - paddle.w/2;
        };

        if(score < requiredScore) gameLoopId = requestAnimationFrame(gameLoop);
        else endBattle();
    }

    function endBattle() {
        cancelAnimationFrame(gameLoopId);
        battleScreen.style.display = "none";
        storyScreen.classList.remove("hidden");
        currentStep++; 
        document.getElementById("action-btn").innerText = "â–¼ NEXT";
        nextScript();
    }

    nextScript();
</script>
</body>
</html>
