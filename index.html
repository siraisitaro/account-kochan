<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KyokaiTsuku Mobile DX - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #f8fafc; height: 100dvh; overflow: hidden; font-family: sans-serif; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
        .chart-container { position: relative; height: 180px; width: 100%; }
        @keyframes slide-in { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-active { display: flex !important; animation: slide-in 0.2s ease-out; }
    </style>
</head>
<body class="text-slate-800 flex flex-col">

    <nav class="bg-slate-900 text-white shrink-0 shadow-lg p-4">
        <div class="flex justify-between items-center">
            <div class="font-bold">教会経営DX <span class="text-[10px] text-yellow-500">v2.1</span></div>
            <div class="text-xs font-mono" id="uiDate">Y1-M1-W1</div>
        </div>
        <div class="grid grid-cols-3 gap-2 mt-2 text-[10px] text-center">
            <div class="bg-slate-800 p-1 rounded">資金: <span id="uiFunds" class="text-emerald-400">¥0</span></div>
            <div class="bg-slate-800 p-1 rounded">信徒: <span id="uiMembers" class="text-blue-300">0</span></div>
            <div class="bg-slate-800 p-1 rounded">維持費: <span id="uiCost" class="text-red-400">¥0</span></div>
        </div>
    </nav>

    <main id="mainArea" class="flex-grow p-4 overflow-y-auto pb-32 bg-slate-50"></main>

    <div class="fixed bottom-24 right-5 z-30">
        <button onclick="app.processWeek()" class="w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center border-4 border-white active:scale-90 transition-transform">
            <i class="fa-solid fa-person-praying text-2xl text-yellow-500"></i>
        </button>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-3 pb-6 safe-area-bottom">
        <button onclick="app.setTab('dashboard')" class="text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-chart-line text-lg"></i>経営</button>
        <button onclick="app.setTab('personnel')" class="text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-user-tie text-lg"></i>人事</button>
        <button onclick="app.setTab('facility')" class="text-xs flex flex-col items-center gap-1"><i class="fa-solid fa-church text-lg"></i>設備</button>
    </nav>

    <div id="resultModal" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-xs p-6">
            <h3 class="font-bold mb-4 text-center">週次結果</h3>
            <div id="resDetail" class="text-sm space-y-2 mb-6 text-slate-600"></div>
            <button onclick="app.closeResult()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold">確認</button>
        </div>
    </div>

    <script>
        const FACILITIES = [
            { name: '自宅', cost: 0, upkeep: 5000, cap: 15, bonus: 0 },
            { name: '会議室', cost: 300000, upkeep: 20000, cap: 40, bonus: 10 },
            { name: 'テナント', cost: 1500000, upkeep: 50000, cap: 80, bonus: 20 }
        ];

        const game = {
            state: { year: 1, month: 1, week: 1, funds: 1000000, members: 5, facilityLevel: 0, staff: [], history: [] },
            save() { localStorage.setItem('kt_v2_fixed', JSON.stringify(this.state)); },
            load() { 
                const d = localStorage.getItem('kt_v2_fixed'); 
                if(d) this.state = JSON.parse(d);
            },
            calc() {
                let p = 10, c = 10, a = 10;
                this.state.staff.forEach(s => { p+=s.stats.preach; c+=s.stats.care; a+=s.stats.admin; });
                const f = FACILITIES[this.state.facilityLevel];
                return { preach: p + f.bonus, care: c, admin: a, upkeep: Math.floor(f.upkeep + (this.state.staff.reduce((acc,s)=>acc+s.salary, 0)/4)) };
            }
        };

        const app = {
            tab: 'dashboard',
            init() {
                console.log("App Initializing...");
                game.load();
                if(game.state.staff.length === 0) {
                    game.state.staff = [{ name: 'あなた', role: 'pastor', stats: { preach: 20, care: 10, admin: 10 }, salary: 100000 }];
                }
                this.updateUI();
                this.render();
            },
            setTab(t) { this.tab = t; this.render(); },
            processWeek() {
                const s = game.state;
                const stats = game.calc();
                const f = FACILITIES[s.facilityLevel];
                
                let att = Math.min(f.cap, Math.floor(s.members * (0.8 + stats.preach * 0.01)));
                let inc = att * (2000 + stats.admin * 10);
                let newM = Math.floor(stats.preach / 15);
                let lostM = Math.max(0, Math.floor((s.members * 2 - stats.care) / 10));
                
                s.funds += (inc - stats.upkeep);
                s.members = Math.max(1, s.members + newM - lostM);
                
                document.getElementById('resDetail').innerHTML = `
                    <div class="flex justify-between"><span>収入:</span><span class="text-emerald-600">+¥${inc.toLocaleString()}</span></div>
                    <div class="flex justify-between"><span>支出:</span><span class="text-red-500">-¥${stats.upkeep.toLocaleString()}</span></div>
                    <hr>
                    <div class="flex justify-between font-bold"><span>来会者:</span><span>${att}名</span></div>
                `;
                
                s.week++; if(s.week>4){ s.week=1; s.month++; if(s.month>12){ s.month=1; s.year++; } }
                s.history.push({ w: `${s.month}/${s.week}`, m: s.members });
                if(s.history.length > 10) s.history.shift();
                
                game.save();
                document.getElementById('resultModal').classList.add('modal-active');
                this.updateUI();
            },
            closeResult() { document.getElementById('resultModal').classList.remove('modal-active'); this.render(); },
            updateUI() {
                const s = game.state;
                const stats = game.calc();
                document.getElementById('uiDate').innerText = `Y${s.year}-M${s.month}-W${s.week}`;
                document.getElementById('uiFunds').innerText = `¥${s.funds.toLocaleString()}`;
                document.getElementById('uiMembers').innerText = s.members;
                document.getElementById('uiCost').innerText = `¥${stats.upkeep.toLocaleString()}`;
            },
            render() {
                const main = document.getElementById('mainArea');
                if(this.tab === 'dashboard') {
                    main.innerHTML = `
                        <div class="bg-white p-4 rounded-lg shadow-sm border mb-4">
                            <h3 class="text-xs text-slate-400 mb-2">信徒数推移</h3>
                            <div class="chart-container"><canvas id="growthChart"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border">
                            <h3 class="text-xs text-slate-400 mb-2">スタッフ</h3>
                            ${game.state.staff.map(st => `<div class="text-sm py-1 border-b flex justify-between"><span>${st.name}</span><span>${st.salary}/月</span></div>`).join('')}
                        </div>`;
                    this.renderChart();
                } else {
                    main.innerHTML = `<div class="text-center py-20 text-slate-400">Coming Soon...<br>(他のタブは開発中)</div>`;
                }
            },
            renderChart() {
                const ctx = document.getElementById('growthChart');
                if(!ctx || typeof Chart === 'undefined') return;
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: game.state.history.map(h => h.w),
                        datasets: [{ data: game.state.history.map(h => h.m), borderColor: '#fbbf24', tension: 0.3 }]
                    },
                    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
